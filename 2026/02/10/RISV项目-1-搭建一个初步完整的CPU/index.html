<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<!-- 标题 -->
<title>RISC-V项目(1)---搭建一个初步完整的CPU | 风继续吹</title>

<!-- 网站描述 -->
<meta name="description" content="">
<meta name="keywords" content="RISC-V">
<meta name="author" content="风继续吹">

<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:title" content="RISC-V项目(1)---搭建一个初步完整的CPU">
<meta property="og:description" content="">
<meta property="og:url" content="http://example.com/2026/02/10/RISV%E9%A1%B9%E7%9B%AE-1-%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%88%9D%E6%AD%A5%E5%AE%8C%E6%95%B4%E7%9A%84CPU/index.html">
<meta property="og:site_name" content="风继续吹">


<!-- Favicon -->

<link rel="icon" href="/images/laozhichi.ico">


<!-- 预连接 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- 字体 -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<!-- 样式表 -->

<link rel="stylesheet" href="/css/style.css">


<!-- RSS -->


<!-- 规范链接 -->
<link rel="canonical" href="http://example.com/2026/02/10/RISV%E9%A1%B9%E7%9B%AE-1-%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%88%9D%E6%AD%A5%E5%AE%8C%E6%95%B4%E7%9A%84CPU/index.html">

<!-- 主题色 -->
<meta name="theme-color" content="#2563eb" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#1e293b" media="(prefers-color-scheme: dark)">

<!-- 自定义样式变量 -->
<style>
  :root {
    --primary-color: #2563eb;
  }
</style>

<meta name="generator" content="Hexo 8.1.1"></head>
<body>
  <header class="site-header">
  <div class="header-container">
    <!-- Logo / 站点标题 -->
    <div class="site-brand">
      <a href="/" class="site-logo">
        
          <img src="/images/laozhichi.ico#%20%E7%95%99%E7%A9%BA%E5%88%99%E6%98%BE%E7%A4%BA%E7%AB%99%E7%82%B9%E6%A0%87%E9%A2%98" alt="风继续吹">
        
      </a>
    </div>

    <!-- 导航菜单 -->
    <nav class="site-nav">
      <ul class="nav-list">
        
          <li class="nav-item">
            <a href="/" 
               class="nav-link ">
              首页
            </a>
          </li>
        
          <li class="nav-item">
            <a href="/archives" 
               class="nav-link ">
              归档
            </a>
          </li>
        
          <li class="nav-item">
            <a href="/about" 
               class="nav-link ">
              关于
            </a>
          </li>
        
      </ul>
    </nav>

    <!-- 工具栏 -->
    <div class="header-tools">
      <!-- 搜索按钮 -->
      
        <button class="tool-btn search-toggle" aria-label="搜索" title="搜索">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
          </svg>
        </button>
      

      <!-- 主题切换 -->
      
        <button class="tool-btn theme-toggle" aria-label="切换主题" title="切换主题">
          <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 2v2"></path>
            <path d="M12 20v2"></path>
            <path d="m4.93 4.93 1.41 1.41"></path>
            <path d="m17.66 17.66 1.41 1.41"></path>
            <path d="M2 12h2"></path>
            <path d="M20 12h2"></path>
            <path d="m6.34 17.66-1.41 1.41"></path>
            <path d="m19.07 4.93-1.41 1.41"></path>
          </svg>
          <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
          </svg>
        </button>
      

      <!-- 移动端菜单按钮 -->
      <button class="tool-btn menu-toggle" aria-label="菜单" title="菜单">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="4" x2="20" y1="12" y2="12"></line>
          <line x1="4" x2="20" y1="6" y2="6"></line>
          <line x1="4" x2="20" y1="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>

  <!-- 移动端导航 -->
  <div class="mobile-nav">
    <ul class="mobile-nav-list">
      
        <li class="mobile-nav-item">
          <a href="/" 
             class="mobile-nav-link ">
            首页
          </a>
        </li>
      
        <li class="mobile-nav-item">
          <a href="/archives" 
             class="mobile-nav-link ">
            归档
          </a>
        </li>
      
        <li class="mobile-nav-item">
          <a href="/about" 
             class="mobile-nav-link ">
            关于
          </a>
        </li>
      
    </ul>
  </div>
</header>

  
  <main class="main-content">
    <div class="container">
      <div class="page-layout post-layout">
  <article class="post-article">
    <!-- 文章头部 -->
    <header class="post-header">
      <h1 class="post-title">RISC-V项目(1)---搭建一个初步完整的CPU</h1>
      
      <!-- 元信息 -->
      <div class="post-meta">
  <!-- 发布日期 -->
  <span class="meta-item meta-date">
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
      <line x1="16" x2="16" y1="2" y2="6"></line>
      <line x1="8" x2="8" y1="2" y2="6"></line>
      <line x1="3" x2="21" y1="10" y2="10"></line>
    </svg>
    <time datetime="2026-02-10">
      2026-02-10
    </time>
  </span>

  <!-- 更新日期 -->
  

  <!-- 字数统计 -->
  
    <span class="meta-item meta-wordcount">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17 6.1H3"></path>
        <path d="M21 12.1H3"></path>
        <path d="M15.1 18H3"></path>
      </svg>
      
      24.4k 字
    </span>
  

  <!-- 阅读时间 -->
  
    <span class="meta-item meta-readtime">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      
      约 82 分钟
    </span>
  

  <!-- 标签（仅在列表页显示前几个） -->
  
</div>

      
      <!-- 封面图 -->
      
    </header>

    <!-- 文章内容 -->
    <div class="post-content markdown-body">
      <meta name="referrer" content="no-referrer" />

<blockquote>
<p>这个文章我们从0开始实现一个CPU,完整地实现取指、译码、执行、回写四大操作过程。</p>
</blockquote>
<h3 id="1、PC计数器"><a href="#1、PC计数器" class="headerlink" title="1、PC计数器"></a>1、PC计数器</h3><ul>
<li>核心逻辑 (Logic Flow)：<br>①复位 (Reset)：rst_n 拉低时，PC 归零。<br>②跳转 (Jump)：当 jump_en 为 1，PC 强制更新为目标地址 jump_addr（用于分支或函数调用）。<br>③顺序执行 (Fetch)：默认情况下，PC 每周期 +4（对应 32 位指令字长），自动指向下一条指令。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">module pc_counter#(</span><br><span class="line">	parameter AW =32</span><br><span class="line">)(</span><br><span class="line">	input logic clk,</span><br><span class="line">	input logic rst_n,</span><br><span class="line">	input logic jump_en,</span><br><span class="line">	input logic [AW-1:0] jump_addr,</span><br><span class="line">	output logic [AW-1:0] pc_pointer</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">always_ff@(posedge clk or negedge rst_n)begin</span><br><span class="line">	if(!rst_n)</span><br><span class="line">		pc_pointer&lt;=&#x27;h0;</span><br><span class="line">	else if(jump_en)</span><br><span class="line">		pc_pointer&lt;=jump_addr;</span><br><span class="line">	else</span><br><span class="line">		pc_pointer&lt;=pc_pointer+&#x27;h4;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">endmodule</span><br></pre></td></tr></table></figure>

<h3 id="2、ROM存储器"><a href="#2、ROM存储器" class="headerlink" title="2、ROM存储器"></a>2、ROM存储器</h3><ul>
<li>核心逻辑 (Logic Flow)：<br>①初始化 (Initialization)：利用 $readmemh 在仿真开始瞬间，从指定路径（如 rv32ui-p-addi.txt）读取十六进制指令，填满 4KB (4096 x 32bit) 的数组。<br>②字对齐 (Word Alignment)：核心代码是 rom_reg[addr_in[AW-1:2]]。因为 PC 是按字节 (Byte) 寻址，而 ROM 是按 32位字 (Word) 存储，所以取地址时必须丢弃低两位（相当于除以 4），否则取到的指令全是错的。<br>③组合逻辑读取 (Asynchronous Read)：使用 always_comb，数据输出不依赖时钟边沿，地址一变，指令立马出来。</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> rom #(</span><br><span class="line">	<span class="keyword">parameter</span> AW=<span class="number">32</span>,</span><br><span class="line">	<span class="keyword">parameter</span> DW=<span class="number">32</span>,</span><br><span class="line">	<span class="keyword">parameter</span> file = <span class="string">&quot;rv32ui-p-addi.txt&quot;</span></span><br><span class="line">)(</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> [AW-<span class="number">1</span>:<span class="number">0</span>] addr_in,</span><br><span class="line">	<span class="keyword">output</span> <span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>] data_out</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">string</span> PATH=<span class="string">&quot;../test_data/&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">string</span> full_path=&#123;PATH,file&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>] rom_reg [<span class="number">0</span>:<span class="number">4095</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">	<span class="built_in">$readmemh</span>(full_path,rom_reg);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">	data_out=rom_reg[addr_in[AW-<span class="number">1</span>:<span class="number">2</span>]];</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>

<h3 id="3、if2id"><a href="#3、if2id" class="headerlink" title="3、if2id"></a>3、if2id</h3><p>我们的CPU的使用流水线寄存器 (Pipeline Register)，if2id体位于 取指 (IF) 和 译码 (ID) 阶段之间。它的作用是切断关键路径，让 CPU 能够跑得更快。</p>
<p>这个模块核心的功能就是：把pc寄存器给的地址，还有把从ROM取得的指令，用寄存器切割，然后再传到下一级</p>
<p>但是这里是涉及到流水线冲刷的，我们来用几个图简单看一下流水线冲刷机制是啥：</p>
<img src="https://img2024.cnblogs.com/blog/3728231/202602/3728231-20260210184128995-532502531.png">

<img src="https://img2024.cnblogs.com/blog/3728231/202602/3728231-20260210185302912-686759942.png">

<p>检测到有跳转指令后，进行指令冲刷</p>
<img src="https://img2024.cnblogs.com/blog/3728231/202602/3728231-20260210185443550-1393588096.png">

<p>赋值为 NOP (No Operation)，唯一的目的就是为了无害化处理。</p>
<p>为什么要保护那 32 个寄存器？(The Why)</p>
<ul>
<li><p>CPU 的流水线最终都会汇聚到一个阶段：写回 (Write Back, WB)。<br>正常情况：指令经过运算后，会把结果写进寄存器堆（Register File，那 32 个通用寄存器）。<br>危险情况：如果刚才因为分支预测失败（Flush），流水线里残留了一条错误的指令（比如 add x1, x2, x3），如果不把它变成 NOP，它就会一路跑到 WB 阶段，把 x1 的值改掉。<br>后果：程序逻辑直接崩盘，因为 x1 被错误地污染了。<br>NOP 的作用就是告诉 WB 阶段：“别动！什么都别写！当作无事发生。</p>
</li>
<li><p>在 RISC-V 中，NOP 其实是一个伪指令。它实际上是：$$\text{addi } x0, x0, 0$$</p>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">define</span>.sv&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> if2id #(</span><br><span class="line">	<span class="keyword">parameter</span> AW=<span class="number">32</span>,</span><br><span class="line">	<span class="keyword">parameter</span> DW=<span class="number">32</span></span><br><span class="line">)(</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> clk,</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> rst_n,</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> [AW-<span class="number">1</span>:<span class="number">0</span>] in_addr,</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>] in_instruction,</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> instr_flush,</span><br><span class="line">	<span class="keyword">output</span> <span class="keyword">logic</span> [AW-<span class="number">1</span>:<span class="number">0</span>] out_addr,</span><br><span class="line">	<span class="keyword">output</span> <span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>] out_instruction</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n)<span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">if</span>(!rst_n)<span class="keyword">begin</span></span><br><span class="line">		out_addr&lt;=<span class="number">&#x27;h0</span>;</span><br><span class="line">		out_instruction&lt;=`INST_NOP;</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(instr_flush)<span class="keyword">begin</span></span><br><span class="line">		out_addr&lt;=<span class="number">&#x27;h0</span>;</span><br><span class="line">		out_instruction&lt;=`INST_NOP;		</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">		out_addr&lt;=in_addr;</span><br><span class="line">		out_instruction&lt;=in_instruction;</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>

<h3 id="4、deine-sv指令解析"><a href="#4、deine-sv指令解析" class="headerlink" title="4、deine.sv指令解析"></a>4、deine.sv指令解析</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">timescale</span> 1ns / 1ps</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/****************************************Copyright (c)**************************************************</span></span><br><span class="line"><span class="comment">**----------------------------------------File Info-----------------------------------------------------</span></span><br><span class="line"><span class="comment">** File name          : define</span></span><br><span class="line"><span class="comment">** Last modified Date : 2025-11-01</span></span><br><span class="line"><span class="comment">** Last Version       : 1.0</span></span><br><span class="line"><span class="comment">** Descriptions       : define</span></span><br><span class="line"><span class="comment">**------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">*******************************************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 全局参数定义 =====</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> AW             32              </span><span class="comment">// Address Width: 地址总线位宽 (32位 CPU)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> DW             32              </span><span class="comment">// Data Width: 数据总线位宽 (32位 CPU)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> FILE           &quot;rv32ui-p-addi.dat&quot; </span><span class="comment">// 默认加载的测试文件 (仿真用)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="comment">// I-Type 指令 (立即数运算)</span></span><br><span class="line"><span class="comment">// 格式: Opcode(7) + Rd(5) + Funct3(3) + Rs1(5) + Imm(12)</span></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_TYPE_I    7&#x27;b0010011      </span><span class="comment">// I-Type 的主操作码 (Opcode)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面是 Funct3 字段，用于区分具体的运算类型</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_ADDI      3&#x27;b000          </span><span class="comment">// 加立即数 (Add Immediate)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SLTI      3&#x27;b010          </span><span class="comment">// 小于置位立即数 (Set Less Than Immediate)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SLTIU     3&#x27;b011          </span><span class="comment">// 无符号小于置位立即数</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_XORI      3&#x27;b100          </span><span class="comment">// 异或立即数</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_ORI       3&#x27;b110          </span><span class="comment">// 或立即数</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_ANDI      3&#x27;b111          </span><span class="comment">// 与立即数</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SLLI      3&#x27;b001          </span><span class="comment">// 逻辑左移立即数 (Shift Left Logical Imm)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SRI       3&#x27;b101          </span><span class="comment">// 右移立即数 (包含逻辑右移 SRLI 和 算术右移 SRAI，需靠 funct7 区分)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="comment">// L-Type 指令 (加载指令 Load)</span></span><br><span class="line"><span class="comment">// 作用：从内存读数据到寄存器</span></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_TYPE_L    7&#x27;b0000011      </span><span class="comment">// Load 指令的主操作码</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_LB        3&#x27;b000          </span><span class="comment">// Load Byte (加载字节，带符号扩展)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_LH        3&#x27;b001          </span><span class="comment">// Load Halfword (加载半字/16位)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_LW        3&#x27;b010          </span><span class="comment">// Load Word (加载字/32位)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_LBU       3&#x27;b100          </span><span class="comment">// Load Byte Unsigned (加载字节，零扩展)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_LHU       3&#x27;b101          </span><span class="comment">// Load Halfword Unsigned</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="comment">// S-Type 指令 (存储指令 Store)</span></span><br><span class="line"><span class="comment">// 作用：把寄存器的数据写回内存</span></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_TYPE_S    7&#x27;b0100011      </span><span class="comment">// Store 指令的主操作码</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SB        3&#x27;b000          </span><span class="comment">// Store Byte</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SH        3&#x27;b001          </span><span class="comment">// Store Halfword</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SW        3&#x27;b010          </span><span class="comment">// Store Word</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="comment">// R-Type &amp; M-Type 指令 (寄存器-寄存器运算)</span></span><br><span class="line"><span class="comment">// 警告：标准运算(R)和乘除法扩展(M)共享同一个 Opcode！</span></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_TYPE_R_M  7&#x27;b0110011      </span><span class="comment">// R-Type 的主操作码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- 标准 R-Type (基本 ALU 运算) ---</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_ADD_SUB   3&#x27;b000          </span><span class="comment">// 加法/减法 (靠 funct7 的第30位区分)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SLL       3&#x27;b001          </span><span class="comment">// 逻辑左移</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SLT       3&#x27;b010          </span><span class="comment">// 小于置位</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SLTU      3&#x27;b011          </span><span class="comment">// 无符号小于置位</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_XOR       3&#x27;b100          </span><span class="comment">// 异或</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_SR        3&#x27;b101          </span><span class="comment">// 逻辑右移/算术右移 (靠 funct7 区分)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_OR        3&#x27;b110          </span><span class="comment">// 或</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_AND       3&#x27;b111          </span><span class="comment">// 与</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// --- M-Extension (乘除法扩展) ---</span></span><br><span class="line"><span class="comment">// 注意：它们的 funct3 和上面的 R-Type 是重叠的！</span></span><br><span class="line"><span class="comment">// 例如 INST_MUL (000) 和 INST_ADD_SUB (000) 一样。</span></span><br><span class="line"><span class="comment">// 必须检查 funct7 字段是否为 0000001 才能确认为是乘除法。</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_MUL       3&#x27;b000          </span><span class="comment">// 乘法 (低32位)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_MULH      3&#x27;b001          </span><span class="comment">// 乘法 (高32位，有符号)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_MULHSU    3&#x27;b010          </span><span class="comment">// 乘法 (高32位，有符号x无符号)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_MULHU     3&#x27;b011          </span><span class="comment">// 乘法 (高32位，无符号)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_DIV       3&#x27;b100          </span><span class="comment">// 除法 (有符号)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_DIVU      3&#x27;b101          </span><span class="comment">// 除法 (无符号)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_REM       3&#x27;b110          </span><span class="comment">// 取余 (有符号)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_REMU      3&#x27;b111          </span><span class="comment">// 取余 (无符号)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="comment">// J-Type &amp; U-Type (跳转与长立即数)</span></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_JAL       7&#x27;b1101111      </span><span class="comment">// JAL 跳转并链接 (直接跳转)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_JALR      7&#x27;b1100111      </span><span class="comment">// JALR 寄存器跳转 (间接跳转)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_LUI       7&#x27;b0110111      </span><span class="comment">// 加载高位立即数 (Load Upper Imm)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_LUIPC     7&#x27;b0010111      </span><span class="comment">// 加载高位立即数加到 PC (PC相对寻址核心)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="comment">// 特殊指令与伪指令</span></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_NOP       32&#x27;h00000013    </span><span class="comment">// 空指令 (实际上是 addi x0, x0, 0)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_NOP_OP    7&#x27;b0000001      </span><span class="comment">// 这个定义有点奇怪，可能是自定义的 NOP 操作码？</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_MRET      32&#x27;h30200073    </span><span class="comment">// 从机器模式异常返回 (Machine Return)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_RET       32&#x27;h00008067    </span><span class="comment">// 函数返回 (实际上是 jalr x0, x1, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_FENCE     7&#x27;b0001111      </span><span class="comment">// 内存屏障 (用于多核或乱序执行)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_ECALL     32&#x27;h00000073    </span><span class="comment">// 环境调用 (系统调用 System Call)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_EBREAK    32&#x27;h00100073    </span><span class="comment">// 环境断点 (调试用 Debug)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="comment">// B-Type 指令 (分支 Branch)</span></span><br><span class="line"><span class="comment">// =========================================================</span></span><br><span class="line"><span class="comment">// 原代码注释写错了 &quot;J type inst&quot;，这是 B-Type！</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_TYPE_B    7&#x27;b1100011      </span><span class="comment">// Branch 指令主操作码</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_BEQ       3&#x27;b000          </span><span class="comment">// 相等跳转 (Branch if Equal)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_BNE       3&#x27;b001          </span><span class="comment">// 不等跳转 (Branch if Not Equal)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_BLT       3&#x27;b100          </span><span class="comment">// 小于跳转 (Branch if Less Than)</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_BGE       3&#x27;b101          </span><span class="comment">// 大于等于跳转</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_BLTU      3&#x27;b110          </span><span class="comment">// 无符号小于跳转</span></span><br><span class="line"><span class="meta">`<span class="keyword">define</span> INST_BGEU      3&#x27;b111          </span><span class="comment">// 无符号大于等于跳转</span></span><br></pre></td></tr></table></figure>

<h3 id="5、通用寄存器register"><a href="#5、通用寄存器register" class="headerlink" title="5、通用寄存器register"></a>5、通用寄存器register</h3><ul>
<li><p>2R1W 结构：支持 2路读 (read_rs1, read_rs2) 和 1路写 (ex_write)。这是现代 RISC-V 整数流水线的标准配置。</p>
</li>
<li><p>32个寄存器：通过 regs[0:31] 定义了 x0 到 x31。</p>
</li>
<li><p>x0 恒零保护 (Zero Register Protection)<br>读的时候：read_rs1_addr &#x3D;&#x3D; ‘h0 时，强制输出 0。<br>写的时候：ex_write_addr !&#x3D; ‘h0 时才允许写入。<br>作用：完美符合 RISC-V 规范，确保 x0 永远是 0，怎么写都没用。</p>
</li>
<li><p>内部前递 (Internal Forwarding &#x2F; Write-through) —— 这段代码的精华！</p>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(ex_wirite_en &amp;&amp; (read_rs1_addr == ex_write_addr))</span><br><span class="line">    out_rs1_data = ex_write_data; <span class="comment">// 直接输出写入的数据</span></span><br></pre></td></tr></table></figure>
<p>场景：如果在同一个时钟周期内，你既要读地址 x5，又要往 x5 写新值。如果没有这段逻辑，读出来的就是“旧值”；有了这段逻辑，读出来的就是“新值”。这能让流水线少停顿一个周期。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> register #(</span><br><span class="line">	<span class="keyword">parameter</span> DW=<span class="number">32</span></span><br><span class="line">)(</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> clk,</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> rst_n,</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] read_rs1_addr,</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] read_rs2_addr,</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">output</span> <span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>] out_rs1_data,</span><br><span class="line">	<span class="keyword">output</span> <span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>] out_rs2_data,</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> ex_write_en,</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] ex_write_addr,</span><br><span class="line">	<span class="keyword">input</span> <span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>] ex_write_data</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>] regs[<span class="number">0</span>:<span class="number">31</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">if</span>(!rst_n)</span><br><span class="line">		out_rs1_data=<span class="number">&#x27;h0</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(read_rs1_addr==<span class="number">&#x27;h0</span>)</span><br><span class="line">		out_rs1_data=<span class="number">&#x27;h0</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(ex_wirite_en&amp;&amp;(read_rs1_addr==ex_write_addr))</span><br><span class="line">		out_rs1_data=ex_write_data;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		out_rs1_data=regs[read_rs1_addr];</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">if</span>(!rst_n)</span><br><span class="line">		out_rs2_data=<span class="number">&#x27;h0</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(read_rs2_addr==<span class="number">&#x27;h0</span>)</span><br><span class="line">		out_rs2_data=<span class="number">&#x27;h0</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(ex_write_en&amp;&amp;(read_rs2_addr==ex_write_addr))</span><br><span class="line">		out_rs2_data=ex_write_data;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		out_rs2_data=regs[read_rs2_addr];</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always_ff</span>@(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n)<span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">if</span>(!rst_n)<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">32</span>;i++)<span class="keyword">begin</span></span><br><span class="line">			regs[i]&lt;=<span class="number">&#x27;h0</span>;</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(ex_write_en&amp;&amp;(ex_write_addr!=<span class="number">&#x27;h0</span>))</span><br><span class="line">		regs[ex_write_addr]&lt;=ex_write_data;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>


<h3 id="6、decoder"><a href="#6、decoder" class="headerlink" title="6、decoder"></a>6、decoder</h3><p>①JALR指令：<br>jalr 指令使用 12 位立即数（有符号数）作为偏移量，与操作数寄存器 rs1中的值相加,然后将结果的最低有效位置0。jalr指令将其下一条指令的 PC（即当前指令PC+4）的值写入其结果寄存器 rd。</p>
<p>立即数为20位到31位的指令：</p>
<p>L型指令：<br><img src="https://img2024.cnblogs.com/blog/3728231/202602/3728231-20260210205904898-2131646971.png"></p>
<p>S型指令：</p>
<img src="https://img2024.cnblogs.com/blog/3728231/202602/3728231-20260210210138262-750101696.png">

<p>B型指令：</p>
<img src="https://img2024.cnblogs.com/blog/3728231/202602/3728231-20260210210329822-1836804222.png">



<p>模块名称：Decoder (译码器) 核心功能：</p>
<ul>
<li>切片 (Slicing)：将 32 位指令切割成 opcode, rs1, rs2, rd, funct3&#x2F;7。</li>
<li>立即数生成 (Imm Gen)：根据指令类型（I&#x2F;S&#x2F;B&#x2F;J&#x2F;U），将碎片化的立即数拼接并扩展为 32 位。</li>
<li>操作数分发 (Operand Mux)：根据指令类型，决定 ALU 的两个输入操作数 (op1, op2) 到底来自寄存器堆 (rs_data)、PC (in_addr) 还是立即数 (imm)。</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">timescale</span> 1ns /1ps                                                                                     </span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">define</span>.sv&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> decode	#(</span><br><span class="line">	<span class="keyword">parameter</span>	AW								= <span class="number">32</span>								,</span><br><span class="line">	<span class="keyword">parameter</span>	DW								=	<span class="number">32</span>		</span><br><span class="line">)( </span><br><span class="line">  <span class="keyword">input</span>		<span class="keyword">logic</span>	[AW-<span class="number">1</span>:<span class="number">0</span>]  		instr_addr_in<span class="comment">//PC寄存器的地址				,</span></span><br><span class="line">  <span class="keyword">input</span>		<span class="keyword">logic</span>	[DW-<span class="number">1</span>:<span class="number">0</span>]			instr_in	<span class="comment">//ROM中存放的指令instruction					,</span></span><br><span class="line">  <span class="comment">//to register</span></span><br><span class="line">  <span class="keyword">output</span>	<span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>]  				rd_rs1_addr		<span class="comment">//解析指令后获取源地址1			,</span></span><br><span class="line">  <span class="keyword">output</span> 	<span class="keyword">logic</span>	[<span class="number">4</span>:<span class="number">0</span>]  				rd_rs2_addr		<span class="comment">//解析指令后获取源地址2			,</span></span><br><span class="line">  <span class="comment">//from register	</span></span><br><span class="line">  <span class="keyword">input</span>		<span class="keyword">logic</span>	[DW-<span class="number">1</span>:<span class="number">0</span>]			rd_rs1_data		<span class="comment">//把源地址1给通用寄存器后获取到的数据1			, </span></span><br><span class="line">  <span class="keyword">input</span>		<span class="keyword">logic</span>	[DW-<span class="number">1</span>:<span class="number">0</span>]	 		rd_rs2_data		<span class="comment">//把源地址2给通用寄存器后获取到的数据2			, </span></span><br><span class="line">  <span class="comment">//to instr execute</span></span><br><span class="line">  <span class="keyword">output</span> 	<span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>]			op1_out				<span class="comment">//把操作数1传出去			,</span></span><br><span class="line">  <span class="keyword">output</span> 	<span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>]			op2_out				<span class="comment">//把操作数2传出去	</span></span><br><span class="line">);  </span><br><span class="line"></span><br><span class="line"><span class="keyword">logic</span>	[<span class="number">6</span>:<span class="number">0</span>]										opcode							;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>]  									rd									;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>]  									func3								;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>]  									rs1									;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>]  									rs2									;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>]  									func7   						;</span><br><span class="line"><span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>]  								imm									;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">assign</span>	opcode								= instr_in[<span class="number">6</span>:<span class="number">0</span>]			;</span><br><span class="line"><span class="keyword">assign</span>  rd										= instr_in[<span class="number">11</span>:<span class="number">7</span>]		;</span><br><span class="line"><span class="keyword">assign</span>  func3									= instr_in[<span class="number">14</span>:<span class="number">12</span>]		;</span><br><span class="line"><span class="keyword">assign</span>  rs1										= instr_in[<span class="number">19</span>:<span class="number">15</span>]		;</span><br><span class="line"><span class="keyword">assign</span>  rs2     							= instr_in[<span class="number">24</span>:<span class="number">20</span>]		;</span><br><span class="line"><span class="keyword">assign</span>  func7   							= instr_in[<span class="number">31</span>:<span class="number">25</span>]		;</span><br><span class="line"></span><br><span class="line"><span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">case</span>(opcode)</span><br><span class="line">		`INST_TYPE_I,`INST_TYPE_L,`INST_JALR:</span><br><span class="line">			imm = &#123;&#123;<span class="number">20</span>&#123;instr_in[<span class="number">31</span>]&#125;&#125;,instr_in[<span class="number">31</span>:<span class="number">20</span>]&#125;;</span><br><span class="line">		`INST_TYPE_S:</span><br><span class="line">			imm = &#123;&#123;<span class="number">20</span>&#123;instr_in[<span class="number">31</span>]&#125;&#125;,instr_in[<span class="number">31</span>:<span class="number">25</span>],instr_in[<span class="number">11</span>:<span class="number">7</span>]&#125;;</span><br><span class="line">		`INST_TYPE_B:</span><br><span class="line">			imm = &#123;&#123;<span class="number">20</span>&#123;instr_in[<span class="number">31</span>]&#125;&#125;,instr_in[<span class="number">7</span>],instr_in[<span class="number">30</span>:<span class="number">25</span>],instr_in[<span class="number">11</span>:<span class="number">8</span>],<span class="number">1&#x27;b0</span>&#125;;</span><br><span class="line">		`INST_JAL:</span><br><span class="line">		  imm = &#123;&#123;<span class="number">12</span>&#123;instr_in[<span class="number">31</span>]&#125;&#125;,instr_in[<span class="number">19</span>:<span class="number">12</span>],instr_in[<span class="number">20</span>],instr_in[<span class="number">30</span>:<span class="number">21</span>],	<span class="number">1&#x27;b0</span>&#125;;</span><br><span class="line">		 `INST_LUI,`INST_LUIPC:</span><br><span class="line">		 	imm = &#123;instr_in[<span class="number">31</span>:<span class="number">12</span>],<span class="number">12&#x27;h0</span>&#125;;</span><br><span class="line">		<span class="keyword">default</span>:imm = <span class="number">32&#x27;h0</span>;</span><br><span class="line">	<span class="keyword">endcase</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">always_comb</span>	<span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">case</span>(opcode)</span><br><span class="line">		`INST_TYPE_I:<span class="keyword">begin</span></span><br><span class="line">			<span class="keyword">case</span>(func3)</span><br><span class="line">				`INST_ADDI:<span class="keyword">begin</span></span><br><span class="line">					rd_rs1_addr  = rs1	 										;</span><br><span class="line">					rd_rs2_addr  = <span class="number">5&#x27;h0</span>							    		;</span><br><span class="line">					op1_out			 = rd_rs1_data							;</span><br><span class="line">					op2_out			 = imm											;</span><br><span class="line">				<span class="keyword">end</span>                                   		</span><br><span class="line">				<span class="keyword">default</span>:<span class="keyword">begin</span>                         		</span><br><span class="line">					rd_rs1_addr  = <span class="number">&#x27;h0</span>	 										;</span><br><span class="line">					rd_rs2_addr  = <span class="number">&#x27;h0</span>						    			;</span><br><span class="line">					op1_out			 = <span class="number">&#x27;h0</span>											;</span><br><span class="line">					op2_out			 = <span class="number">&#x27;h0</span>											;</span><br><span class="line">				<span class="keyword">end</span></span><br><span class="line">			<span class="keyword">endcase</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		`INST_TYPE_R_M:<span class="keyword">begin</span></span><br><span class="line">			<span class="keyword">case</span>(func3)</span><br><span class="line">				`INST_ADD_SUB:<span class="keyword">begin</span></span><br><span class="line">					rd_rs1_addr  = rs1	 										;</span><br><span class="line">					rd_rs2_addr  = rs2						    			;</span><br><span class="line">					op1_out			 = rd_rs1_data							;</span><br><span class="line">					op2_out			 = rd_rs2_data							;</span><br><span class="line">				<span class="keyword">end</span>                                   		</span><br><span class="line">				<span class="keyword">default</span>:<span class="keyword">begin</span>                         		</span><br><span class="line">					rd_rs1_addr  = <span class="number">&#x27;h0</span>	 										;</span><br><span class="line">					rd_rs2_addr  = <span class="number">&#x27;h0</span>						    			;</span><br><span class="line">					op1_out			 = <span class="number">&#x27;h0</span>											;</span><br><span class="line">					op2_out			 = <span class="number">&#x27;h0</span>											;</span><br><span class="line">				<span class="keyword">end</span></span><br><span class="line">			<span class="keyword">endcase</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		`INST_TYPE_B:<span class="keyword">begin</span></span><br><span class="line">			<span class="keyword">case</span>(func3)</span><br><span class="line">				`INST_BNE:<span class="keyword">begin</span></span><br><span class="line">					rd_rs1_addr  = rs1	 										;</span><br><span class="line">					rd_rs2_addr  = rs2						    			;</span><br><span class="line">					op1_out			 = rd_rs1_data							;</span><br><span class="line">					op2_out			 = rd_rs2_data							;</span><br><span class="line">				<span class="keyword">end</span>                                   		</span><br><span class="line">				<span class="keyword">default</span>:<span class="keyword">begin</span>                         		</span><br><span class="line">					rd_rs1_addr  = <span class="number">&#x27;h0</span>	 										;</span><br><span class="line">					rd_rs2_addr  = <span class="number">&#x27;h0</span>						    			;</span><br><span class="line">					op1_out			 = <span class="number">&#x27;h0</span>											;</span><br><span class="line">					op2_out			 = <span class="number">&#x27;h0</span>											;</span><br><span class="line">				<span class="keyword">end</span></span><br><span class="line">			<span class="keyword">endcase</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		`INST_JAL:<span class="keyword">begin</span></span><br><span class="line">			rd_rs1_addr  = <span class="number">5&#x27;h0</span>	 												;</span><br><span class="line">			rd_rs2_addr  = <span class="number">5&#x27;h0</span>						    					;</span><br><span class="line">			op1_out			 = <span class="number">32&#x27;h0</span>												;</span><br><span class="line">			op2_out			 = imm													;</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		`INST_JALR:<span class="keyword">begin</span></span><br><span class="line">			rd_rs1_addr  = rs1	 												;</span><br><span class="line">			rd_rs2_addr  = <span class="number">5&#x27;h0</span>						    					;</span><br><span class="line">			op1_out			 = rd_rs1_data									;</span><br><span class="line">			op2_out			 = imm													;</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		`INST_LUI:<span class="keyword">begin</span></span><br><span class="line">			rd_rs1_addr  = <span class="number">5&#x27;h0</span>		 											;</span><br><span class="line">			rd_rs2_addr  = <span class="number">5&#x27;h0</span>						    					;</span><br><span class="line">			op1_out			 = <span class="number">32&#x27;h0</span>												;</span><br><span class="line">			op2_out			 = imm													;</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		`INST_LUIPC:<span class="keyword">begin</span></span><br><span class="line">			rd_rs1_addr  = <span class="number">5&#x27;h0</span>		 											;</span><br><span class="line">			rd_rs2_addr  = <span class="number">5&#x27;h0</span>						    					;</span><br><span class="line">			op1_out			 = instr_addr_in								;</span><br><span class="line">			op2_out			 = imm													;</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		`INST_NOP_OP: <span class="keyword">begin</span></span><br><span class="line">			rd_rs1_addr  = <span class="number">5&#x27;h0</span>		 											;</span><br><span class="line">			rd_rs2_addr  = <span class="number">5&#x27;h0</span>						    					;</span><br><span class="line">			op1_out			 = <span class="number">32&#x27;h0</span>												;</span><br><span class="line">			op2_out			 = <span class="number">32&#x27;h0</span>												;</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">default</span>:<span class="keyword">begin</span></span><br><span class="line">			rd_rs1_addr  = <span class="number">&#x27;h0</span>	 												;</span><br><span class="line">			rd_rs2_addr  = <span class="number">&#x27;h0</span>						    					;</span><br><span class="line">			op1_out			 = <span class="number">&#x27;h0</span>													;</span><br><span class="line">			op2_out			 = <span class="number">&#x27;h0</span>													;</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">endcase</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>

<h3 id="7、id2ex"><a href="#7、id2ex" class="headerlink" title="7、id2ex"></a>7、id2ex</h3><p>instruction to excute</p>
<p>核心位置：位于 译码阶段 (ID) 和 执行阶段 (EX) 之间。</p>
<ul>
<li><p>主要功能：打拍（隔离）。在时钟上升沿，将译码出的 PC地址、指令码、操作数 1 (op1)、操作数 2 (op2) 锁存并传递给执行单元。</p>
</li>
<li><p>instr_flush 信号在这里 不是“保持” (Stall)，而是 “冲刷” (Flush)。</p>
</li>
<li><p>当 instr_flush 为 1 时，它把输出强制设为 NOP (空指令) 和 0，相当于向流水线插入了一个气泡。</p>
</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">define</span>.sv&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> id2ex #(</span><br><span class="line">	<span class="keyword">parameter</span>	AW								= <span class="number">32</span>								,</span><br><span class="line">	<span class="keyword">parameter</span>	DW								=	<span class="number">32</span>	</span><br><span class="line">	)( </span><br><span class="line">  <span class="keyword">input</span>		<span class="keyword">logic</span>        				clk									,</span><br><span class="line">  <span class="keyword">input</span>   <span class="keyword">logic</span>     					rst_n								,</span><br><span class="line">  <span class="keyword">input</span>		<span class="keyword">logic</span>								instr_flush					,</span><br><span class="line">  <span class="keyword">input</span>   <span class="keyword">logic</span> [AW-<span class="number">1</span>:<span class="number">0</span>]			instr_addr_in				,</span><br><span class="line">  <span class="keyword">input</span>   <span class="keyword">logic</span>	[DW-<span class="number">1</span>:<span class="number">0</span>]			instr_in						,</span><br><span class="line">  <span class="keyword">input</span>   <span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>]			op1_in							,</span><br><span class="line">  <span class="keyword">input</span>   <span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>]			op2_in							,</span><br><span class="line">  <span class="comment">//to execute</span></span><br><span class="line">  <span class="keyword">output</span> 	<span class="keyword">logic</span> [AW-<span class="number">1</span>:<span class="number">0</span>]			instr_addr_out			,</span><br><span class="line">  <span class="keyword">output</span> 	<span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>]			instr_out						,</span><br><span class="line">  <span class="keyword">output</span> 	<span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>]			op1_out							,</span><br><span class="line">  <span class="keyword">output</span> 	<span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>]			op2_out								</span><br><span class="line">);  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">negedge</span> rst_n)</span><br><span class="line">	<span class="keyword">if</span>(!rst_n) <span class="keyword">begin</span></span><br><span class="line">		instr_addr_out		&lt;= <span class="number">&#x27;h0</span>;</span><br><span class="line">		instr_out					&lt;= `INST_NOP;</span><br><span class="line">		op1_out						&lt;= <span class="number">&#x27;h0</span>;</span><br><span class="line">		op2_out						&lt;= <span class="number">&#x27;h0</span>;</span><br><span class="line">	<span class="keyword">end</span> </span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(instr_flush) <span class="keyword">begin</span></span><br><span class="line">		instr_addr_out		&lt;= <span class="number">&#x27;h0</span>;</span><br><span class="line">		instr_out					&lt;= `INST_NOP;</span><br><span class="line">		op1_out						&lt;= <span class="number">&#x27;h0</span>;</span><br><span class="line">		op2_out						&lt;= <span class="number">&#x27;h0</span>;</span><br><span class="line">	<span class="keyword">end</span>  </span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">		instr_addr_out		&lt;= instr_addr_in;</span><br><span class="line">		instr_out					&lt;= instr_in			;</span><br><span class="line">		op1_out						&lt;= op1_in				;</span><br><span class="line">		op2_out						&lt;= op2_in				;</span><br><span class="line">	<span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="8、excute"><a href="#8、excute" class="headerlink" title="8、excute"></a>8、excute</h3><p>我们重点来看一下B型指令的组成：</p>
<ul>
<li><ol>
<li>第 0 位 (imm[0])：强制填 0<br>来源：无（不需要指令提供）。<br>操作：直接补一个 0。<br>为什么：RISC-V 规定跳转地址必须是 2 的倍数（偶数），所以最低位永远是 0。</li>
</ol>
</li>
<li><ol start="2">
<li>第 1~4 位 (imm[4:1])：抓指令的 [11:8]<br>来源：instr[11:8]<br>操作：直接搬过来。</li>
</ol>
</li>
<li><ol start="3">
<li>第 5~10 位 (imm[10:5])：抓指令的<br>来源：instr[30:25]<br>操作：直接搬过来。</li>
</ol>
</li>
<li><ol start="4">
<li>第 11 位 (imm[11])：抓指令的 [7]<br>来源：instr[7]<br>注意：这就是最“乱”的那一位，它独自藏在指令的低位里。</li>
</ol>
</li>
<li><ol start="5">
<li>第 12 位 (imm[12])：抓指令的 [31]<br>来源：instr[31] (最高位)<br>意义：这是符号位（正负号）。</li>
</ol>
</li>
<li><ol start="6">
<li>第 13~31 位 (imm[31:13])：复制符号位<br>来源：还是 instr[31]<br>操作：把第 12 位拿到的那个数（0或1），疯狂复制 19 次，填满剩下的高位。这叫符号扩展。</li>
</ol>
</li>
</ul>
<img src="https://img2024.cnblogs.com/blog/3728231/202602/3728231-20260210231042898-1261426171.png">

<p>我们来看一下B型、JAL型、JALR型指令地址的转换是怎么计算的</p>
<ul>
<li>B型 &#x2F; JAL：以 PC 为基准起跳 (PC + imm)。</li>
<li>JALR：以 寄存器 (rs1) 为基准起跳 (rs1 + imm)。</li>
</ul>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="keyword">timescale</span> 1ns / 1ps</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==========================================</span></span><br><span class="line"><span class="comment">// 模块功能：执行阶段 (EX Stage)</span></span><br><span class="line"><span class="comment">// 核心任务：</span></span><br><span class="line"><span class="comment">// 1. 算术运算 (加减法)</span></span><br><span class="line"><span class="comment">// 2. 跳转目标地址计算 (Branch/JAL/JALR)</span></span><br><span class="line"><span class="comment">// 3. 生成写回寄存器的数据 (Result)</span></span><br><span class="line"><span class="comment">// ==========================================</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">include</span> &quot;<span class="keyword">define</span>.sv&quot; </span><span class="comment">// 包含指令操作码宏定义</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> execute #(</span><br><span class="line">	<span class="keyword">parameter</span>	AW	= <span class="number">32</span>, <span class="comment">// 地址位宽</span></span><br><span class="line">	<span class="keyword">parameter</span>	DW	= <span class="number">32</span>  <span class="comment">// 数据位宽</span></span><br><span class="line">)(</span><br><span class="line">	<span class="comment">// --- Input Ports (来自 ID/EX 寄存器) ---</span></span><br><span class="line">	<span class="keyword">input</span>  	<span class="keyword">logic</span> [AW-<span class="number">1</span>:<span class="number">0</span>]			instr_addr,   <span class="comment">// 当前指令 PC</span></span><br><span class="line">	<span class="keyword">input</span>		<span class="keyword">logic</span>	[DW-<span class="number">1</span>:<span class="number">0</span>]			instr,        <span class="comment">// 当前指令二进制码</span></span><br><span class="line">	<span class="keyword">input</span>   <span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>]			op1,          <span class="comment">// 操作数 1 (rs1)</span></span><br><span class="line">	<span class="keyword">input</span>   <span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>]			op2,          <span class="comment">// 操作数 2 (rs2 或 imm)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- Output Ports (去往 MEM/WB 阶段或 寄存器堆) ---</span></span><br><span class="line">	<span class="keyword">output</span> 	<span class="keyword">logic</span>          			wr_reg_en,    <span class="comment">// 寄存器写使能</span></span><br><span class="line">	<span class="keyword">output</span> 	<span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>]					wr_reg_addr,  <span class="comment">// 目标寄存器 rd</span></span><br><span class="line">	<span class="keyword">output</span> 	<span class="keyword">logic</span> [DW-<span class="number">1</span>:<span class="number">0</span>]			wr_reg_data,  <span class="comment">// 写回的数据 (Result)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- Output Ports (去往 Control Unit 控制跳转) ---</span></span><br><span class="line">	<span class="keyword">output</span> 	<span class="keyword">logic</span>          			jump_en,      <span class="comment">// 跳转请求 (1=跳)</span></span><br><span class="line">	<span class="keyword">output</span> 	<span class="keyword">logic</span> [AW-<span class="number">1</span>:<span class="number">0</span>]  		jump_addr,    <span class="comment">// 跳转目标地址</span></span><br><span class="line">	<span class="keyword">output</span> 	<span class="keyword">logic</span>          			jump_hold     <span class="comment">// [注意] 流水线控制信号 (Hold? Flush?)</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- Internal Signals ---</span></span><br><span class="line">	<span class="keyword">logic</span>	[<span class="number">6</span>:<span class="number">0</span>]			opcode;   <span class="comment">// 主操作码</span></span><br><span class="line">	<span class="keyword">logic</span>   [<span class="number">4</span>:<span class="number">0</span>] 			rd;       <span class="comment">// 目标寄存器索引</span></span><br><span class="line">	<span class="keyword">logic</span>   [<span class="number">2</span>:<span class="number">0</span>]  			func3;    <span class="comment">// 功能码 3位</span></span><br><span class="line">	<span class="keyword">logic</span>   [<span class="number">6</span>:<span class="number">0</span>]  			func7;    <span class="comment">// 功能码 7位</span></span><br><span class="line">	<span class="keyword">logic</span>	[<span class="number">31</span>:<span class="number">0</span>]  		imm;      <span class="comment">// B-Type 立即数</span></span><br><span class="line">	<span class="keyword">logic</span>					equal;    <span class="comment">// 比较结果</span></span><br><span class="line">	<span class="keyword">logic</span>	[AW-<span class="number">1</span>:<span class="number">0</span>]		jump_imm; <span class="comment">// B-Type 跳转目标</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- Instruction Decoding (硬连线切片) ---</span></span><br><span class="line">	<span class="keyword">assign</span>	opcode = instr[<span class="number">6</span>:<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">assign</span>  rd     = instr[<span class="number">11</span>:<span class="number">7</span>];</span><br><span class="line">	<span class="keyword">assign</span>  func3  = instr[<span class="number">14</span>:<span class="number">12</span>];</span><br><span class="line">	<span class="keyword">assign</span>  func7  = instr[<span class="number">31</span>:<span class="number">25</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- B-Type Immediate Generation ---</span></span><br><span class="line">	<span class="comment">// 复杂的位拼接，用于还原乱序存储的 B 型指令立即数，并做符号扩展</span></span><br><span class="line">	<span class="keyword">assign</span>	imm    = &#123;&#123;<span class="number">20</span>&#123;instr[<span class="number">31</span>]&#125;&#125;,instr[<span class="number">7</span>],instr[<span class="number">30</span>:<span class="number">25</span>],instr[<span class="number">11</span>:<span class="number">8</span>],<span class="number">1&#x27;b0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- Comparator (用于 BNE/BEQ) ---</span></span><br><span class="line">	<span class="keyword">assign</span>	equal  = (op1 == op2) ? <span class="number">1&#x27;b1</span> : <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- PC-Relative Address Calculation (用于 B-Type) ---</span></span><br><span class="line">	<span class="comment">// 当前 PC + 偏移量 = 目标 PC</span></span><br><span class="line">	<span class="keyword">assign</span>	jump_imm = instr_addr + imm;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- Main Execution Logic (Combinational) ---</span></span><br><span class="line">	<span class="keyword">always_comb</span>	<span class="keyword">begin</span></span><br><span class="line">		<span class="keyword">case</span>(opcode)</span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			<span class="comment">// I-Type Instructions (Immediate Ops)</span></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			`INST_TYPE_I:<span class="keyword">begin</span></span><br><span class="line">				<span class="keyword">case</span>(func3)</span><br><span class="line">					`INST_ADDI:<span class="keyword">begin</span>  <span class="comment">// ADDI: rd = rs1 + imm</span></span><br><span class="line">						wr_reg_en  	 = <span class="number">1&#x27;b1</span>;</span><br><span class="line">						wr_reg_addr  = rd;</span><br><span class="line">						wr_reg_data	 = op1 + op2; <span class="comment">// op2 应该是 Decode 阶段选好的 imm</span></span><br><span class="line">						jump_en			 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">						jump_addr		 = <span class="number">&#x27;h0</span>;</span><br><span class="line">						jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">					<span class="keyword">end</span></span><br><span class="line">					<span class="keyword">default</span>:<span class="keyword">begin</span>     <span class="comment">// Default behavior for undefined I-type</span></span><br><span class="line">						wr_reg_en  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">						wr_reg_addr  = <span class="number">5&#x27;h0</span>;</span><br><span class="line">						wr_reg_data	 = <span class="number">&#x27;h0</span>;</span><br><span class="line">						jump_en			 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">						jump_addr		 = <span class="number">&#x27;h0</span>;</span><br><span class="line">						jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">					<span class="keyword">end</span></span><br><span class="line">				<span class="keyword">endcase</span></span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			<span class="comment">// R-Type / M-Type (Register Ops)</span></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			`INST_TYPE_R_M:<span class="keyword">begin</span></span><br><span class="line">				<span class="keyword">case</span>(func3)</span><br><span class="line">					`INST_ADD_SUB:<span class="keyword">begin</span></span><br><span class="line">						<span class="comment">// 根据 func7 区分 ADD (0000000) 和 SUB (0100000)</span></span><br><span class="line">						<span class="keyword">if</span>(func7 == <span class="number">7&#x27;b000_0000</span>) <span class="keyword">begin</span> <span class="comment">// ADD: rd = rs1 + rs2</span></span><br><span class="line">							wr_reg_en  	 = <span class="number">1&#x27;b1</span>;</span><br><span class="line">							wr_reg_addr  = rd;</span><br><span class="line">							wr_reg_data	 = op1 + op2;</span><br><span class="line">							jump_en			 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">							jump_addr		 = <span class="number">&#x27;h0</span>;</span><br><span class="line">							jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">						<span class="keyword">end</span></span><br><span class="line">						<span class="keyword">else</span> <span class="keyword">begin</span>                     <span class="comment">// SUB: rd = rs1 - rs2</span></span><br><span class="line">							wr_reg_en  	 = <span class="number">1&#x27;b1</span>;</span><br><span class="line">							wr_reg_addr  = rd;</span><br><span class="line">							wr_reg_data	 = op1 - op2;</span><br><span class="line">							jump_en			 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">							jump_addr		 = <span class="number">&#x27;h0</span>;</span><br><span class="line">							jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">						<span class="keyword">end</span></span><br><span class="line">					<span class="keyword">end</span></span><br><span class="line">					<span class="keyword">default</span>:<span class="keyword">begin</span></span><br><span class="line">						wr_reg_en  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">						wr_reg_addr  = <span class="number">5&#x27;h0</span>;</span><br><span class="line">						wr_reg_data	 = <span class="number">&#x27;h0</span>;</span><br><span class="line">						jump_en			 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">						jump_addr		 = <span class="number">&#x27;h0</span>;</span><br><span class="line">						jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">					<span class="keyword">end</span></span><br><span class="line">				<span class="keyword">endcase</span></span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			<span class="comment">// B-Type (Branch Instructions)</span></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			`INST_TYPE_B: <span class="keyword">begin</span></span><br><span class="line">				<span class="keyword">case</span>(func3)</span><br><span class="line">					`INST_BNE: <span class="keyword">begin</span> <span class="comment">// BNE: Branch if Not Equal</span></span><br><span class="line">						wr_reg_en  	 = <span class="number">1&#x27;b0</span>;        <span class="comment">// 分支指令不写通用寄存器</span></span><br><span class="line">						wr_reg_addr  = <span class="number">5&#x27;h0</span>;</span><br><span class="line">						wr_reg_data	 = <span class="number">&#x27;h0</span>;</span><br><span class="line">						<span class="comment">// 如果不相等 (~equal)，则跳转使能置 1</span></span><br><span class="line">						jump_en			 = ~equal;</span><br><span class="line">						<span class="comment">// 跳转目标设为算好的 jump_imm</span></span><br><span class="line">						jump_addr		 = ~equal ? jump_imm : <span class="number">&#x27;h0</span>;</span><br><span class="line">						<span class="comment">// [红色警报] 这里依然是 0。</span></span><br><span class="line">						<span class="comment">// 如果架构设计需要 EX 级发出冲刷信号，这里必须是 ~equal (即跟 jump_en 一致)</span></span><br><span class="line">						jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">					<span class="keyword">end</span></span><br><span class="line">					<span class="keyword">default</span>:<span class="keyword">begin</span></span><br><span class="line">						wr_reg_en  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">						wr_reg_addr  = <span class="number">5&#x27;h0</span>;</span><br><span class="line">						wr_reg_data	 = <span class="number">&#x27;h0</span>;</span><br><span class="line">						jump_en			 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">						jump_addr		 = <span class="number">&#x27;h0</span>;</span><br><span class="line">						jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">					<span class="keyword">end</span></span><br><span class="line">				<span class="keyword">endcase</span></span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			<span class="comment">// JAL (Jump and Link)</span></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			`INST_JAL:<span class="keyword">begin</span></span><br><span class="line">				 wr_reg_en  	 = <span class="number">1&#x27;b1</span>;</span><br><span class="line">				 wr_reg_addr   = rd;</span><br><span class="line">				 wr_reg_data	 = instr_addr + <span class="number">32&#x27;h4</span>;  <span class="comment">// 链接：保存返回地址 (PC+4)</span></span><br><span class="line">				 jump_en			 = <span class="number">1&#x27;b1</span>;                <span class="comment">// 强制跳转</span></span><br><span class="line">				 <span class="comment">// JAL 目标地址 = PC + imm (op2 必须是 decode 传来的 imm)</span></span><br><span class="line">				 jump_addr		 = instr_addr + op2;</span><br><span class="line">				 <span class="comment">// [红色警报] 这里也应该是 1 (如果是冲刷逻辑)</span></span><br><span class="line">				 jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			<span class="comment">// JALR (Jump and Link Register)</span></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			`INST_JALR:<span class="keyword">begin</span></span><br><span class="line">				 wr_reg_en  	 = <span class="number">1&#x27;b1</span>;</span><br><span class="line">				 wr_reg_addr   = rd;</span><br><span class="line">				 wr_reg_data	 = instr_addr + <span class="number">32&#x27;h4</span>;  <span class="comment">// 链接</span></span><br><span class="line">				 jump_en			 = <span class="number">1&#x27;b1</span>;                <span class="comment">// 强制跳转</span></span><br><span class="line">				 <span class="comment">// JALR 目标地址 = rs1 + imm (即 op1 + op2)</span></span><br><span class="line">				 jump_addr		 = op1 + op2;</span><br><span class="line">				 <span class="comment">// [红色警报] 这里也应该是 1</span></span><br><span class="line">				 jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			<span class="comment">// LUI (Load Upper Immediate)</span></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			`INST_LUI:<span class="keyword">begin</span></span><br><span class="line">				 wr_reg_en  	 = <span class="number">1&#x27;b1</span>;</span><br><span class="line">				 wr_reg_addr   = rd;</span><br><span class="line">				 wr_reg_data	 = op2;  <span class="comment">// op2 在 decode 阶段已处理为 &#123;imm, 12&#x27;h0&#125;</span></span><br><span class="line">				 jump_en			 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">				 jump_addr		 = <span class="number">&#x27;h0</span>;</span><br><span class="line">				 jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			<span class="comment">// LUIPC (Load Upper Immediate to PC)</span></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			`INST_LUIPC:<span class="keyword">begin</span></span><br><span class="line">				 wr_reg_en  	 = <span class="number">1&#x27;b1</span>;</span><br><span class="line">				 wr_reg_addr   = rd;</span><br><span class="line">				 wr_reg_data	 = op1 + op2; <span class="comment">// PC + imm</span></span><br><span class="line">				 jump_en			 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">				 jump_addr		 = <span class="number">&#x27;h0</span>;</span><br><span class="line">				 jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			<span class="comment">// NOP (No Operation)</span></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			`INST_NOP_OP:<span class="keyword">begin</span></span><br><span class="line">				wr_reg_en  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">				wr_reg_addr  = <span class="number">5&#x27;h0</span>;</span><br><span class="line">				wr_reg_data	 = <span class="number">&#x27;h0</span>;</span><br><span class="line">				jump_en			 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">				jump_addr		 = <span class="number">&#x27;h0</span>;</span><br><span class="line">				jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			<span class="comment">// Default (Undefined Instruction)</span></span><br><span class="line">			<span class="comment">// ------------------------------------</span></span><br><span class="line">			<span class="keyword">default</span>:<span class="keyword">begin</span></span><br><span class="line">				wr_reg_en  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">				wr_reg_addr  = <span class="number">5&#x27;h0</span>;</span><br><span class="line">				wr_reg_data	 = <span class="number">&#x27;h0</span>;</span><br><span class="line">				<span class="comment">// [注意] 默认行为是跳转到 0 地址重启</span></span><br><span class="line">				jump_en			 = <span class="number">1&#x27;b1</span>;</span><br><span class="line">				jump_addr		 = <span class="number">&#x27;h0</span>;</span><br><span class="line">				jump_hold  	 = <span class="number">1&#x27;b0</span>;</span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">endcase</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>


    </div>

    <!-- 标签 -->
    
      <div class="post-tags">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"></path>
          <path d="M7 7h.01"></path>
        </svg>
        
          <a href="/tags/RISC-V/" class="tag-link">RISC-V</a>
        
      </div>
    

    <!-- 版权信息 -->
    

    <!-- 上一篇 / 下一篇 -->
    <nav class="post-nav">
      
        <div class="post-nav-item prev disabled"></div>
      
      
      
        <div class="post-nav-item next disabled"></div>
      
    </nav>
  </article>

  <!-- TOC 目录 -->
  
    <aside class="post-toc">
      <div class="toc-wrapper">
        <h3 class="toc-title">目录</h3>
        <div class="toc-content">
          <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81PC%E8%AE%A1%E6%95%B0%E5%99%A8"><span class="toc-text">1、PC计数器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81ROM%E5%AD%98%E5%82%A8%E5%99%A8"><span class="toc-text">2、ROM存储器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81if2id"><span class="toc-text">3、if2id</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81deine-sv%E6%8C%87%E4%BB%A4%E8%A7%A3%E6%9E%90"><span class="toc-text">4、deine.sv指令解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E9%80%9A%E7%94%A8%E5%AF%84%E5%AD%98%E5%99%A8register"><span class="toc-text">5、通用寄存器register</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81decoder"><span class="toc-text">6、decoder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81id2ex"><span class="toc-text">7、id2ex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81excute"><span class="toc-text">8、excute</span></a></li></ol>
        </div>
      </div>
    </aside>
  
</div>

    </div>
  </main>

  <footer class="site-footer">
  <div class="footer-container">
    <div class="footer-content">
      <!-- 版权信息 -->
      <div class="footer-copyright">
        <p>
          &copy; 
          
            2025 - 
          
          2026 
          <a href="/">风继续吹</a>
        </p>
      </div>

      <!-- 社交链接 -->
      
        <div class="footer-social">
          
          
          
            <a href="2436757134@qq.com" aria-label="Email" title="Email">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="20" height="16" x="2" y="4" rx="2"></rect>
                <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
              </svg>
            </a>
          
        </div>
      

      <!-- 技术支持 -->
      <div class="footer-powered">
        <p>
          Powered by <a href="https://hexo.io" target="_blank" rel="noopener noreferrer">Hexo</a>
          <span class="separator">|</span>
          Theme Starter
        </p>
      </div>

      <!-- 备案信息 -->
      

      <!-- 自定义内容 -->
      
    </div>
  </div>
</footer>

  
  <!-- 搜索模态框 -->
  
    <div id="search-modal" class="search-modal">
  <div class="search-container">
    <!-- 搜索头部 -->
    <div class="search-header">
      <div class="search-input-wrapper">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
        <input 
          type="text" 
          id="search-input" 
          class="search-input" 
          placeholder="搜索文章、文档..." 
          autocomplete="off"
          autofocus
        >
        <button class="search-close" aria-label="关闭">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18"></path>
            <path d="m6 6 12 12"></path>
          </svg>
        </button>
      </div>
      <div class="search-shortcut">
        <kbd>ESC</kbd> 关闭
        <span class="shortcut-divider">|</span>
        <kbd>↑</kbd><kbd>↓</kbd> 导航
        <span class="shortcut-divider">|</span>
        <kbd>Enter</kbd> 打开
      </div>
    </div>

    <!-- 搜索结果 -->
    <div id="search-results" class="search-results">
      <div class="search-tip">输入关键词开始搜索</div>
    </div>

    <!-- 搜索页脚 -->
    <div class="search-footer">
      <span class="search-footer-text">
        <kbd>Ctrl</kbd> + <kbd>K</kbd> 快速搜索
      </span>
    </div>
  </div>
</div>

  

  <!-- 站点配置 -->
  <script>
    window.STARTER_CONFIG = {
      root: '/',
      searchEnabled: true
    };
  </script>

  <!-- 主脚本 -->
  
<script src="/js/main.js"></script>

  
  
    
<script src="/js/search.js"></script>

  
  
  
    
<script src="/js/doc-sidebar.js"></script>

  
</body>
</html>
